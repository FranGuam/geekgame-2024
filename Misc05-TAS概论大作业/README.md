### 题面

**【课程教材：《不时轻声地用TAS术语遮羞的马里奥同学》】**

> “21 帧规则，那个……flagpole glitch布拉琪……”
>
> “诶，什么？”
>
> “没什么，只是说了一句 ‘这家伙真是个闸总’。”
>
> “能不能停止用 [TAS](https://en.wikipedia.org/wiki/Tool-assisted_speedrun) 术语骂人？！”
>
> 坐在我旁边的那位绝世红帽大叔，马里奥的脸上浮现出了因拿到了状态而骄傲的笑容。
>
> ……但是，事实不是这样的。刚才他说的明明是“你再不 A 上去（指按 A 键）过关的时候就要放炮了”！
>
> 其实我，拥有着世界顶级的 TAS 操作，就算在实机，也可以用 1/60 秒的速度穷尽手柄按键的所有排列组合。
>
> 完全不知道这件事而且今天也用甜言蜜语来撒娇的马里奥实在是让人忍不住发笑？！
>
> 与全体 speedrunner 憧憬的、超高规格可爱的意大利水管工的 ~~青春爱情~~ 喜剧！

**【Flag 1：你过关】**

**在 600 秒内通关红白机版超级马里奥兄弟。**

需提交通关过程中的手柄输入文件。文件中的每个字节代表每帧的输入，从最低位到最高位依次表示是否按下 A、B、选择、开始、上、下、左、右键。可以使用题目提供的手柄输入编辑器完成操作（但是很难用），也可以在本地用模拟器（如 [FCEUX](https://fceux.com/)）录制输入，转换格式后上传。

手柄输入结束时，游戏必须处在 8-4 关马里奥和公主的画面。游戏 ROM、示例输入、评测脚本等见附件。

**【Flag 2：只有神知道的世界】**

**在 90 秒内进入[负世界](https://www.mariowiki.com/Minus_World)。**

手柄输入结束时，游戏必须处在任意负世界关卡（实际上这个版本的游戏里 -1 关是无限循环的，所以只能是 -1）。

**【Flag 3：诗人握持】**

没有通关条件，但是评测脚本会**将 Flag 3 附加到你的手柄输入之后。**也就是说，在播放完你的输入后，Flag 3 中的每个字节会被解释为手柄按键，逐帧输入到游戏中。请通过游戏输出的画面，分析 Flag 3 的内容。整个流程需在 300 秒内完成。

由于这个 Flag 太过逆天，除输入文件外，你还可以提交一个 2048 字节的二进制文件。模拟器在播放你的输入之前，会将其填充进红白机的 `0x0000-0x07ff` 内存处。

**提示：**

- 输入格式**不是** fm2，而是每帧一个字节，因此输入长度限制等于帧数限制，请询问长度限制的选手仔细审题
- Flag 3：看看 [Bad Apple](https://tasvideos.org/8991S)

**如果你在本地运行结果和在线评测不符：**

- 试试使用题目附件中提供的 `bin2fm2.py` 将你提交的二进制文件转换为 FM2 格式，并使用 FCEUX 播放，此时的结果应该与在线评测一致，你可据此调试你的输入；
- 为了兼容不同模拟器输出的录像格式，`bin2fm2.py` 会在生成的 FM2 文件开头插入一帧用来执行红白机的复位操作，请检查你提交的文件开头是否多/少了一帧的输入。

### 提示

- Flag 1：红白机马里奥最短的通关路线为 1-1、1-2、4-1、4-2、8-1、8-2、8-3、8-4，但既然都 TAS 了，不如去[这个网站](https://tasvideos.org/)找找其他人的录像。
- Flag 2：进入负世界需要[在 1-2 跳关处卡墙](https://www.bilibili.com/video/BV1oW411Q7Le)，有些不以进入负世界为目的的 TAS 录像已经做到了这一点，你只要用 FCEUX 的 [TAS Editor](https://fceux.com/web/help/TASEditor.html) 对其稍加修改即可达成条件。
- Flag 3：基本原理如 [Bad Apple](https://tasvideos.org/8991S) 所示，你需要设置内存使游戏从 N-1 开始，保留火花状态一路打到 N-2，并使用火花击杀库巴。在击杀前的一瞬间按住 A 键，即可使 CPU 跳转执行 0x1181（即内存 0x0181）处的代码。你应在此放置一个可以读取手柄输入并显示到屏幕上的 payload。需要注意：
  - 部分模拟器生成的录像文件中可能出现大量 lag frame（滞后帧），这和其他大部分模拟器的行为不符（说的就是你，BizHawk 的 SubNESHawk 模式）。游戏在普通帧中会同时更新画面和读取输入，在 lag frame 中只会更新画面而不会读取输入。此类录像文件在 FCEUX 中无法正常播放，Bad Apple 的录像很不幸就属于这种情况，你可能需要把开头的部分重打一遍。
  - FCEUX 的 TAS Editor 在制作 TAS 录像时不能修改红白机的内存，你可以尝试修改 FCEUX 的源码，或者换一个支持修改内存的模拟器（例如 BizHawk）来手打 TAS 录像。

**可能对你有帮助的链接：**

- [6502 指令系统手册](https://www.masswerk.at/6502/6502_instruction_set.html)
- [NES 编程指南](https://www.nesdev.org/wiki/Programming_guide)
- [马里奥反汇编](https://gist.github.com/1wErt3r/4048722)

### 解答